{% extends "base.html" %}

{% block title %}Home - GardenAI Advisor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center">
        <h1 class="display-4 mb-3"><i class="bi bi-flower1"></i> Welcome to GardenAI Advisor</h1>
        <p class="lead">Your AI-powered companion for healthy home gardening</p>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-4 mb-3">
        <div class="card h-100 text-center p-4">
            <div class="feature-icon">
                <i class="bi bi-camera"></i>
            </div>
            <h5>Instant Analysis</h5>
            <p>Upload or capture plant photos for immediate disease detection</p>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card h-100 text-center p-4">
            <div class="feature-icon">
                <i class="bi bi-cloud-sun"></i>
            </div>
            <h5>Weather-Based</h5>
            <p>Get recommendations based on your local weather conditions</p>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card h-100 text-center p-4">
            <div class="feature-icon">
                <i class="bi bi-translate"></i>
            </div>
            <h5>Multi-Language</h5>
            <p>Available in 10+ Indian languages with voice support</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card p-4">
            <h3 class="mb-4 text-center">Analyze Your Plant</h3>
            
            <form id="analyzeForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-translate"></i> Select Language</label>
                    <select class="form-select" id="language" name="language">
                        {% for code, name in languages.items() %}
                        <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-tree"></i> Plant Type</label>
                    <select class="form-select" id="crop_type" name="crop_type">
                        <option value="auto">Auto-detect</option>
                        {% for crop in crops %}
                        <option value="{{ crop }}">{{ crop.title() }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Select auto-detect if unsure</small>
                </div>
                
                <div class="mb-4">
                    <label class="form-label"><i class="bi bi-image"></i> Upload Plant Photo</label>
                    <input type="file" class="form-control" id="imageFile" name="file" accept="image/*" required>
                    <small class="text-muted">Supported: JPG, PNG (Max 16MB)</small>
                </div>
                
                <div class="mb-3">
                    <img id="imagePreview" src="" alt="Preview" style="max-width: 100%; display: none; border-radius: 10px;">
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-search"></i> Analyze Plant
                    </button>
                </div>
            </form>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Analyzing your plant... This may take a few moments.</p>
            </div>
            
            <div id="resultsContainer" style="display: none; margin-top: 2rem;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('imageFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const spinner = document.getElementById('loadingSpinner');
    const resultsContainer = document.getElementById('resultsContainer');
    
    spinner.classList.add('active');
    resultsContainer.style.display = 'none';
    
    try {
        const response = await fetch('/analyze', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displayResults(data);
        } else {
            throw new Error(data.error || 'Analysis failed');
        }
    } catch (error) {
        resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Error:</strong> ${error.message}
            </div>
        `;
        resultsContainer.style.display = 'block';
    } finally {
        spinner.classList.remove('active');
    }
});

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    const detection = data.detection;
    const weather = data.weather;
    const location = data.location;
    const recommendations = data.recommendations;
    
    const isHealthy = detection.is_healthy;
    const badgeClass = isHealthy ? 'badge-health' : 'badge-disease';
    
    let html = `
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title">
                    <i class="bi bi-clipboard-check"></i> Detection Results
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Plant Type:</strong> ${detection.crop.toUpperCase()}</p>
                        <p><strong>Status:</strong> <span class="badge ${badgeClass}">${detection.disease}</span></p>
                        <p><strong>Confidence:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Location:</strong> ${location.city}, ${location.region}</p>
                        <p><strong>Temperature:</strong> ${weather.temperature}Â°C</p>
                        <p><strong>Humidity:</strong> ${weather.humidity}%</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-lightbulb"></i> Summary</h4>
                <p class="lead">${recommendations.summary}</p>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-exclamation-circle"></i> Immediate Actions</h4>
                <ol>
                    ${recommendations.immediate_actions.map(action => `<li>${action}</li>`).join('')}
                </ol>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-droplet"></i> Watering Guidelines</h4>
                <p><strong>Frequency:</strong> ${recommendations.watering.frequency}</p>
                <p><strong>Amount:</strong> ${recommendations.watering.amount}</p>
                <p><strong>Timing:</strong> ${recommendations.watering.timing}</p>
                <p><em>${recommendations.watering.weather_note}</em></p>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-bag-check"></i> Shopping List</h4>
                <ul>
                    ${recommendations.shopping_list.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-shield-check"></i> Prevention Tips</h4>
                <ul>
                    ${recommendations.prevention_tips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="/detection/${data.detection_id}" class="btn btn-primary">
                <i class="bi bi-eye"></i> View Full Report
            </a>
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="bi bi-printer"></i> Print Report
            </button>
        </div>
    `;
    
    container.innerHTML = html;
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}